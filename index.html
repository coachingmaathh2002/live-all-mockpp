<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math Mock Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-3xl mx-auto p-6 bg-white shadow mt-8 rounded-lg">
    <h1 class="text-3xl font-bold text-center mb-4">Math Mock Test</h1>

    <form id="student-form" class="space-y-4">
      <input type="text" id="student-name" placeholder="Full Name" class="w-full border p-2 rounded" required>
      <input type="text" id="student-id" placeholder="Student ID" class="w-full border p-2 rounded" required>
      <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded">Start Test</button>
    </form>

    <div id="quiz-section" class="hidden mt-6">
      <form id="quiz-form" class="space-y-6"></form>
      <div class="flex justify-between items-center mt-4">
        <div id="timer" class="text-lg font-semibold">--:--</div>
        <button id="submit-quiz" class="bg-green-600 text-white py-2 px-4 rounded">Submit</button>
      </div>
    </div>

    <div id="submission-success" class="hidden text-center mt-6">
      <h2 class="text-xl font-bold">Submission Successful!</h2>
      <p>Thank you for participating.</p>
    </div>

    <div class="text-center mt-10">
      <button id="admin-btn" class="text-sm text-blue-500 underline">Teacher Panel</button>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded max-w-md w-full">
      <h2 class="text-xl font-bold mb-4">Enter Admin Password</h2>
      <input type="password" id="admin-pass" class="border p-2 w-full mb-4" placeholder="Password" />
      <button id="admin-login" class="bg-indigo-600 text-white px-4 py-2 rounded w-full">Login</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="fixed inset-0 bg-gray-900 bg-opacity-90 overflow-auto hidden p-8">
    <div class="bg-white p-6 rounded max-w-4xl w-full mx-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Teacher Panel</h2>
        <button id="close-admin" class="text-red-500 font-bold">X</button>
      </div>

      <h3 class="text-lg font-semibold mt-4 mb-2">Quiz Questions</h3>
      <form id="quiz-editor" class="space-y-4 mb-6">
        <div id="question-list" class="space-y-4"></div>
        <div>
          <label class="block text-sm mb-1">Duration (minutes):</label>
          <input type="number" id="quiz-duration" min="1" value="30" class="w-full border p-2 rounded"/>
        </div>
        <div class="flex space-x-2">
          <button type="button" id="add-question" class="bg-blue-600 text-white px-4 py-2 rounded">Add Question</button>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Save Quiz</button>
        </div>
      </form>

      <h3 class="text-lg font-semibold mb-2">Submissions</h3>
      <div id="submissions" class="overflow-x-auto"></div>
      <button onclick="localStorage.clear(); location.reload();" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">Clear All Data</button>
    </div>
  </div>

  <script>
    const ADMIN_PASSWORD = "12345678900";

    const studentForm = document.getElementById("student-form");
    const quizSection = document.getElementById("quiz-section");
    const quizForm = document.getElementById("quiz-form");
    const submitQuiz = document.getElementById("submit-quiz");
    const timerDisplay = document.getElementById("timer");
    const successMsg = document.getElementById("submission-success");

    let quizData = null;
    let timer = null;
    let timeLeft = 0;

    function getQuizData() {
      const data = localStorage.getItem("math_quiz_data");
      return data ? JSON.parse(data) : null;
    }

    function saveQuizData(data) {
      localStorage.setItem("math_quiz_data", JSON.stringify(data));
    }

    function getSubmissions() {
      return JSON.parse(localStorage.getItem("math_submissions") || "[]");
    }

    function saveSubmission(sub) {
      const submissions = getSubmissions();
      submissions.push(sub);
      localStorage.setItem("math_submissions", JSON.stringify(submissions));
    }

    function startTimer(duration) {
      timeLeft = duration * 60;
      timer = setInterval(() => {
        const min = Math.floor(timeLeft / 60);
        const sec = String(timeLeft % 60).padStart(2, "0");
        timerDisplay.textContent = `${min}:${sec}`;
        if (--timeLeft < 0) {
          clearInterval(timer);
          submitQuiz.click();
        }
      }, 1000);
    }

    studentForm.addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("student-name").value.trim();
      const id = document.getElementById("student-id").value.trim();
      const already = getSubmissions().some(s => s.studentId === id);
      if (already) return alert("You already submitted the test.");

      quizData = getQuizData();
      if (!quizData) return alert("Quiz not found.");

      studentForm.classList.add("hidden");
      quizSection.classList.remove("hidden");

      quizForm.innerHTML = "";
      quizData.questions.forEach((q, i) => {
        const div = document.createElement("div");
        div.innerHTML = `
          <div class="latex-question font-semibold">${q.question}</div>
          ${q.options.map((opt, j) => `
            <label class="block">
              <input type="radio" name="q${i}" value="${j}" class="mr-2"> ${opt}
            </label>
          `).join("")}
        `;
        quizForm.appendChild(div);
      });

      renderMathInElement(quizForm);
      startTimer(quizData.duration);
    });

    submitQuiz.addEventListener("click", () => {
      clearInterval(timer);
      const answers = [];
      let score = 0;
      quizData.questions.forEach((q, i) => {
        const selected = quizForm.querySelector(`input[name="q${i}"]:checked`);
        const ans = selected ? parseInt(selected.value) : -1;
        answers.push(ans);
        if (ans === q.correctAnswer) score += q.points;
      });
      const studentData = {
        studentName: document.getElementById("student-name").value.trim(),
        studentId: document.getElementById("student-id").value.trim(),
        answers,
        score,
        timestamp: new Date().toISOString(),
      };
      saveSubmission(studentData);
      quizSection.classList.add("hidden");
      successMsg.classList.remove("hidden");
    });

    // Admin Panel
    document.getElementById("admin-btn").onclick = () => {
      document.getElementById("admin-modal").classList.remove("hidden");
    };

    document.getElementById("admin-login").onclick = () => {
      const input = document.getElementById("admin-pass").value;
      if (input === ADMIN_PASSWORD) {
        document.getElementById("admin-modal").classList.add("hidden");
        document.getElementById("admin-panel").classList.remove("hidden");
        loadAdmin();
      } else {
        alert("Incorrect password.");
      }
    };

    document.getElementById("close-admin").onclick = () => {
      document.getElementById("admin-panel").classList.add("hidden");
    };

    document.getElementById("add-question").onclick = () => {
      const qContainer = document.getElementById("question-list");
      const index = qContainer.children.length;
      const div = document.createElement("div");
      div.className = "border p-4 rounded";
      div.innerHTML = `
        <label>Question:</label>
        <textarea class="w-full border p-2 rounded mb-2" name="question${index}" rows="2"></textarea>
        <label>Options:</label>
        ${[0,1,2,3].map(i => `<input class="w-full border p-1 mb-1" name="option${index}_${i}" placeholder="Option ${i+1}"/>`).join("")}
        <label>Correct Answer (0-3):</label>
        <input type="number" min="0" max="3" name="correct${index}" class="w-full border p-2 mb-2"/>
        <label>Points:</label>
        <input type="number" min="1" name="points${index}" class="w-full border p-2"/>
      `;
      qContainer.appendChild(div);
    };

    document.getElementById("quiz-editor").addEventListener("submit", e => {
      e.preventDefault();
      const qList = document.getElementById("question-list").children;
      const questions = [];
      for (let i = 0; i < qList.length; i++) {
        const qEl = qList[i];
        const question = qEl.querySelector(`[name=question${i}]`).value;
        const options = [0,1,2,3].map(j => qEl.querySelector(`[name=option${i}_${j}]`).value);
        const correct = parseInt(qEl.querySelector(`[name=correct${i}]`).value);
        const points = parseInt(qEl.querySelector(`[name=points${i}]`).value);
        if (question && options.every(Boolean) && !isNaN(correct) && !isNaN(points)) {
          questions.push({ question, options, correctAnswer: correct, points });
        }
      }
      const duration = parseInt(document.getElementById("quiz-duration").value);
      saveQuizData({ questions, duration });
      alert("Quiz saved!");
    });

    function loadAdmin() {
      const submissions = getSubmissions();
      submissions.sort((a,b) => b.score - a.score);
      const quiz = getQuizData();
      const total = quiz ? quiz.questions.reduce((sum, q) => sum + q.points, 0) : 0;

      const container = document.getElementById("submissions");
      container.innerHTML = `
        <table class="min-w-full text-sm text-left border">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Student</th>
              <th class="p-2">ID</th>
              <th class="p-2">Score</th>
              <th class="p-2">Time</th>
            </tr>
          </thead>
          <tbody>
            ${submissions.map((s, i) => `
              <tr class="border-t">
                <td class="p-2">${i+1}</td>
                <td class="p-2">${s.studentName}</td>
                <td class="p-2">${s.studentId}</td>
                <td class="p-2 font-bold">${s.score} / ${total}</td>
                <td class="p-2">${new Date(s.timestamp).toLocaleString()}</td>
              </tr>`).join("")}
          </tbody>
        </table>
      `;
    }
  </script>
</body>
</html>
